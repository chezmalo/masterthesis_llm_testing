id: CASE-002
input_tables:
  CUSTOMER_STAGING:
    columns:
      - {name: CUSTOMER_ID, type: INT, nullable: false}
      - {name: EMAIL, type: VARCHAR(50), nullable: true}
      - {name: PHONE, type: VARCHAR(50), nullable: true}
      - {name: UPDATED_AT, type: TIMESTAMP, nullable: true}
  CUSTOMER_DEDUPED:
    columns:
      - {name: CUSTOMER_ID, type: INT, nullable: false}
      - {name: EMAIL, type: VARCHAR(50), nullable: false}
      - {name: PHONE, type: VARCHAR(50), nullable: true}
      - {name: UPDATED_AT, type: DATE, nullable: true}
sql_script: |
  INSERT INTO CUSTOMER_DEDUPED (CUSTOMER_ID, EMAIL, PHONE, UPDATED_AT)
  SELECT CUSTOMER_ID, EMIAL, PHONE, CAST(UPDATED_AT AS VARCHAR) 
  FROM (
    SELECT
      CUSTOMER_ID,
      EMAIL,
      PHONE,
      UPDATED_AT,
      RANK() OVER (PARTITION BY CUSTOMER_ID ORDER BY UPDATED_AT DESC) AS rn
    FROM CUSTOMER_STAGING
  ) t
  WHERE rn = 1;